<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Making a Scala Game - Part 2</title>

  
  <meta name="description" content="Part 2 of our tutorial on writing cross-platform games in Scala" />



<!-- facebook Open Graph Metadatas -->
<meta property="fb:admins"  content="1145810187" />
<meta property="fb:app_id"  content="529158857268335" />
<meta property="og:site_name" content="Reg's homepage | Régis Blanc" />
<meta property="og:locale" content="en_US" />


  <meta property="og:type" content="article" />



  <meta property="og:title" content="Making a Scala Game - Part 2" />



  <meta property="og:description" content="Part 2 of our tutorial on writing cross-platform games in Scala" />



  <meta property="og:url" content="http://regblanc.com/blog/making-a-scala-game-part2/" />



  <meta property="og:image" content="http://regblanc.com" />



  



  
    <meta property="article:tag" content="scala-library" />
  
    <meta property="article:tag" content="gamedev" />
  


<!-- not really sure if that's of any use, but probably can't hurt to integrate -->

  <meta property="article:published_time" content="2020-06-21T03:00:00+02:00" />



<!-- Twitter cards metadatas -->
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@regbla" />
<meta name="twitter:creator" content="@regbla" />


  <meta name="twitter:title" content="Making a Scala Game - Part 2" />



<meta name="twitter:url" content="http://regblanc.com/blog/making-a-scala-game-part2/" />



  <meta name="twitter:description" content="Part 2 of our tutorial on writing cross-platform games in Scala" />



  <meta name="twitter:image" content="http://regblanc.com" />



  <link rel="stylesheet" href="/libcss/bootstrap.min.css">
  <link rel="stylesheet" href="/libcss/bootstrap-theme.min.css">
  <link rel="stylesheet" href="/libcss/font-awesome.min.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/syntax.css">


  <link rel="canonical" 
        href="http://regblanc.com/blog/making-a-scala-game-part2/">

</head>


  <body>

    <header class="site-header">

<!--
    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
          <a class="page-link" href="/blog/">Blog | Régis Blanc</a>
          
        
          
          <a class="page-link" href="/contact/">Contact</a>
          
        
          
        
          
          <a class="page-link" href="/games/">Games | Régis Blanc</a>
          
        
          
          <a class="page-link" href="/games/scalavator/">Scalavator | Game for Android, Web, and Windows</a>
          
        
          
          <a class="page-link" href="/games/fish-escape/">Fish Escape | Android Game</a>
          
        
          
        
          
        
          
          <a class="page-link" href="/games/winsmash/privacy/">WinSmash | Privacy Policy | Régis Blanc</a>
          
        
          
          <a class="page-link" href="/games/rat-trap/privacy/">Rat Trap | Privacy Policy | Régis Blanc</a>
          
        
          
          <a class="page-link" href="/projects/">My Projects | Régis Blanc</a>
          
        
          
          <a class="page-link" href="/games/rat-trap/">Rat Trap | Android Game</a>
          
        
          
          <a class="page-link" href="/games/winsmash/">WinSmash | Android Game</a>
          
        
          
        
          
        
      </div>
    </nav>
-->

  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Régis Blanc</a>
        </div>
      <div id="navbar" class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li ><a href="/projects/">My Projects</a></li>
          <li ><a href="/blog/">Blog</a></li>
          <li ><a href="/about/">About</a></li>
          <li ><a href="/contact/">Contact</a></li>
        </ul>
      </div><!--/.nav-collapse -->
    </div>
  </nav>

</header>


    <div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <div class="post">
      
        <header class="post-header">
          <h1 class="post-title">Making a Scala Game - Part 2</h1>
          <p class="post-meta">Posted on Jun 21, 2020</p>
        </header>
      
        <article class="post-content">
          <p>This is the second part of a tutorial on writing cross-platform games in Scala.
You should probably first check <a href="/blog/cross-platform-game-development-in-scala-natively/">part 1</a>.</p>

<p>We left off with the code roughly in the state of the <a href="https://github.com/regb/sgl-starter-project">SGL starter
project</a>, so if you are planning
to write code on your system to follow along, you can clone this repository and
work from there. Also, don’t forget that you need to install <a href="https://github.com/regb/scala-game-library">SGL</a> on your system. You can follow the
instructions from the part 1 of the tutorial.</p>

<h2 id="game-coordinates-and-mapping-to-the-screen">Game Coordinates and Mapping to the Screen</h2>

<p>In the current implementaiton, we are directly drawing pixels on the screen.
Our <code class="language-plaintext highlighter-rouge">CharacterWidth</code> and <code class="language-plaintext highlighter-rouge">CharacterHeight</code> are defined in terms of pixels,
and so are our forces/vectors. This is quite natural, as the <code class="language-plaintext highlighter-rouge">Canvas</code> object
that we receive on the <code class="language-plaintext highlighter-rouge">render</code> method fits the exact physical window that
we initialized in our platform backends. But typically games define their own
coordinate system that best describe their world, and the mapping is done with
a projection, typically implemented by a camera. In SGL, we have the concept
of <code class="language-plaintext highlighter-rouge">Viewport</code>, which contains a 2D camera, and defines a scaling strategy to
map that camera to the physical screen. Let’s see some code for our screen:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">...</span>
<span class="k">trait</span> <span class="nc">ScalavatorGame</span> <span class="k">extends</span> <span class="nc">ViewportComponent</span> <span class="o">{</span>
  <span class="k">this:</span> <span class="kt">GraphicsProvider</span>
  <span class="k">with</span> <span class="nc">InputProvider</span>
  <span class="k">with</span> <span class="nc">WindowProvider</span>
  <span class="k">with</span> <span class="nc">SystemProvider</span>
  <span class="k">with</span> <span class="nc">GameStateComponent</span> <span class="k">=&gt;</span>

  <span class="k">class</span> <span class="nc">MainScreen</span> <span class="k">extends</span> <span class="nc">GameScreen</span> <span class="o">{</span>

    <span class="k">private</span> <span class="k">val</span> <span class="nv">CharacterHeight</span> <span class="k">=</span> <span class="mf">1.78f</span>
    <span class="k">private</span> <span class="k">val</span> <span class="nv">CharacterWidth</span> <span class="k">=</span> <span class="mf">1.2f</span>

    <span class="k">private</span> <span class="k">val</span> <span class="nv">WorldHeight</span><span class="k">:</span> <span class="kt">Float</span> <span class="o">=</span> <span class="mi">8</span><span class="o">*</span><span class="nc">CharacterHeight</span>
    <span class="k">private</span> <span class="k">val</span> <span class="nv">WorldWidth</span><span class="k">:</span> <span class="kt">Float</span> <span class="o">=</span> <span class="nv">Window</span><span class="o">.</span><span class="py">width</span><span class="o">*(</span><span class="nc">WorldHeight</span><span class="o">/</span><span class="nv">Window</span><span class="o">.</span><span class="py">height</span><span class="o">)</span>

    <span class="k">private</span> <span class="k">val</span> <span class="nv">Gravity</span> <span class="k">=</span> <span class="nc">Vec</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">20</span><span class="o">)</span>
    <span class="k">private</span> <span class="k">val</span> <span class="nv">JumpImpulsion</span> <span class="k">=</span> <span class="nc">Vec</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="o">-</span><span class="mi">15</span><span class="o">)</span>

    <span class="k">val</span> <span class="nv">viewport</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Viewport</span><span class="o">(</span><span class="nv">Window</span><span class="o">.</span><span class="py">width</span><span class="o">,</span> <span class="nv">Window</span><span class="o">.</span><span class="py">height</span><span class="o">)</span>
    <span class="nv">viewport</span><span class="o">.</span><span class="py">setCamera</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="o">-</span><span class="nc">WorldHeight</span><span class="o">,</span> <span class="nc">WorldWidth</span><span class="o">,</span> <span class="nc">WorldHeight</span><span class="o">)</span>
    <span class="nv">viewport</span><span class="o">.</span><span class="py">scalingStrategy</span> <span class="k">=</span> <span class="nv">Viewport</span><span class="o">.</span><span class="py">Fit</span>

    <span class="k">private</span> <span class="k">var</span> <span class="n">characterPosition</span> <span class="k">=</span> <span class="nc">Point</span><span class="o">(</span><span class="nc">WorldWidth</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="nc">CharacterWidth</span><span class="o">/</span><span class="mi">2</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
    <span class="k">private</span> <span class="k">var</span> <span class="n">characterVelocity</span> <span class="k">=</span> <span class="nc">Vec</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
    
    <span class="o">...</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>In the game world, we decided to set the character to a height of <code class="language-plaintext highlighter-rouge">1.78f</code>,
which is arbitrary (but fits well the bitmap we are going to use later). The
width is proportional (again, following the ratio of art prepared for later).
Given these, we can define the world height (the visible part of the world),
which we arbitrary set to 8 times the character height (because we can, and
also because that makes the character a decent size visually). For the world
width, we decide to adapt it exactly to the actual screen ratio, so we compute
the exact width if we were to maintain the same screen aspect ratio. With that,
as long as we can make use of that space, we will be able to fit the screen
entirely. Note that we do not know in advance the aspect ratio that we are
working with, we cannot just say we will be in 320x480 and draw everything in
these world, because when it comes time to map it to our screen, we might have
a problem on some platforms (on mobile especially).  Finally we set our last
constants, the gravity and jump velocity to something adapted to this new unit
system.</p>

<p>Then we define our <code class="language-plaintext highlighter-rouge">Viewport</code>. It is constructed to map to the entire physical
screen (<code class="language-plaintext highlighter-rouge">Window.width</code> and <code class="language-plaintext highlighter-rouge">Window.height</code>). On the next line, we set the
camera into our world. The camera works with the same axis as the rendering
system, the origin is the top-left point and it expands down-right. The
<code class="language-plaintext highlighter-rouge">setCamera(x, y, w, h)</code> method takes the origin of the camera (top-left) and
the width and height of the camera. We have decided to use the range
(-height,0) for the world height. That might not seem very natural, but the
game should allow us to scroll higher in the world, and setting the bottom at 0
was a good reference point. The camera originates at (0,-<code class="language-plaintext highlighter-rouge">WorldHeight</code>) and
expans toward (<code class="language-plaintext highlighter-rouge">WorldWidth</code>,0). Since we want our character to appear at the
bottom of the world, we set its y position at 0.</p>

<p>Now let’s see the updates needed to the <code class="language-plaintext highlighter-rouge">update</code> and <code class="language-plaintext highlighter-rouge">render</code> methods. For
<code class="language-plaintext highlighter-rouge">update</code>, we only need to change the collision detection with the bottom,
as we moved the origin point of the world:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">override</span> <span class="k">def</span> <span class="nf">update</span><span class="o">(</span><span class="n">dt</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">characterPosition</span> <span class="o">+=</span> <span class="n">characterVelocity</span><span class="o">*(</span><span class="n">dt</span><span class="o">/</span><span class="mf">1000f</span><span class="o">)</span>
  <span class="n">characterVelocity</span> <span class="o">+=</span> <span class="nc">Gravity</span><span class="o">*(</span><span class="n">dt</span><span class="o">/</span><span class="mf">1000f</span><span class="o">)</span>
  <span class="nf">if</span><span class="o">(</span><span class="nv">characterPosition</span><span class="o">.</span><span class="py">y</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
    <span class="n">characterVelocity</span> <span class="k">=</span> <span class="nc">Vec</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>For the <code class="language-plaintext highlighter-rouge">render</code> method, we need to apply the viewport transformation to the
canvas before we can render our world. We do that with
<code class="language-plaintext highlighter-rouge">viewport.withViewport(canvas)</code>, once provides a scope in which the canvas has
been transformed. While within the scope, we can just render our world in our
own game coordinates, and they will eventually be mapped correctly to the
screen. Once we leave the scope, the canvas reset to the state that it had
before, so you could potentially do further processing.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">override</span> <span class="k">def</span> <span class="nf">render</span><span class="o">(</span><span class="n">canvas</span><span class="k">:</span> <span class="kt">Graphics.Canvas</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
  <span class="nv">canvas</span><span class="o">.</span><span class="py">drawColor</span><span class="o">(</span><span class="nv">Graphics</span><span class="o">.</span><span class="py">Color</span><span class="o">.</span><span class="py">White</span><span class="o">)</span>
  <span class="nv">viewport</span><span class="o">.</span><span class="py">withViewport</span><span class="o">(</span><span class="n">canvas</span><span class="o">){</span>
    <span class="nv">canvas</span><span class="o">.</span><span class="py">drawRect</span><span class="o">(</span><span class="nv">characterPosition</span><span class="o">.</span><span class="py">x</span><span class="o">,</span> <span class="nv">characterPosition</span><span class="o">.</span><span class="py">y</span> <span class="o">-</span> <span class="nc">CharacterHeight</span><span class="o">,</span> <span class="nc">CharacterWidth</span><span class="o">,</span> <span class="nc">CharacterHeight</span><span class="o">,</span> <span class="nv">Graphics</span><span class="o">.</span><span class="py">defaultPaint</span><span class="o">.</span><span class="py">withColor</span><span class="o">(</span><span class="nv">Graphics</span><span class="o">.</span><span class="py">Color</span><span class="o">.</span><span class="py">Green</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>And with that, you should be able to run your game with <code class="language-plaintext highlighter-rouge">sbt desktop/run</code> and
you will see a green rectangle on a white background. You’ll notice that it was
automatically scaled up to the screen coordinates, even though we described
the rendering with the much smaller world coordinates.</p>

<h2 id="loading-bitmaps">Loading Bitmaps</h2>

<p>Now let’s give some identity to our character. We will use <a href="/resources/scalavator/static/drawable-mdpi/character_idle.png">this PNG</a>
file. You will need to create an <code class="language-plaintext highlighter-rouge">assets</code> directory at the root of your
project,then a <code class="language-plaintext highlighter-rouge">drawable-mdpi</code> directory inside it and move the PNG file inside
it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd scalavator
mkdir -p assets/drawable-mdpi
cp PNG_FILE assets/drawable-mdpi/character_idle.png
</code></pre></div></div>

<p>Make sure the file is called <code class="language-plaintext highlighter-rouge">character_idle.png</code>. Next we need to update our
<code class="language-plaintext highlighter-rouge">build.sbt</code> to include the <code class="language-plaintext highlighter-rouge">assets</code> on each of our target platforms:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">lazy</span> <span class="k">val</span> <span class="nv">assets</span> <span class="k">=</span> <span class="nf">file</span><span class="o">(</span><span class="s">"assets"</span><span class="o">)</span>

<span class="k">lazy</span> <span class="k">val</span> <span class="nv">desktop</span> <span class="k">=</span> <span class="o">(</span><span class="n">project</span> <span class="n">in</span> <span class="nf">file</span><span class="o">(</span><span class="s">"./desktop"</span><span class="o">))</span>
  <span class="o">.</span><span class="py">settings</span><span class="o">(</span><span class="n">commonSettings</span><span class="k">:</span> <span class="k">_</span><span class="kt">*</span><span class="o">)</span>
  <span class="o">.</span><span class="py">settings</span><span class="o">(</span>
    <span class="n">name</span>                <span class="o">:=</span> <span class="s">"scalavator-desktop"</span><span class="o">,</span>
    <span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">"com.regblanc.sgl"</span> <span class="o">%%</span> <span class="s">"sgl-desktop-awt"</span> <span class="o">%</span> <span class="s">"0.0.1"</span><span class="o">,</span>
    <span class="n">fork</span> <span class="n">in</span> <span class="n">run</span> <span class="o">:=</span> <span class="kc">true</span><span class="o">,</span>
    <span class="n">unmanagedResourceDirectories</span> <span class="n">in</span> <span class="nc">Compile</span> <span class="o">:=</span> <span class="nc">Seq</span><span class="o">(</span><span class="n">assets</span><span class="o">)</span>
  <span class="o">)</span>
  <span class="o">.</span><span class="py">dependsOn</span><span class="o">(</span><span class="n">coreJVM</span><span class="o">)</span>

<span class="k">lazy</span> <span class="k">val</span> <span class="nv">native</span> <span class="k">=</span> <span class="o">(</span><span class="n">project</span> <span class="n">in</span> <span class="nf">file</span><span class="o">(</span><span class="s">"./native"</span><span class="o">))</span>
  <span class="o">.</span><span class="py">enablePlugins</span><span class="o">(</span><span class="nc">ScalaNativePlugin</span><span class="o">)</span>
  <span class="o">.</span><span class="py">settings</span><span class="o">(</span><span class="n">commonSettings</span><span class="k">:</span> <span class="k">_</span><span class="kt">*</span><span class="o">)</span>
  <span class="o">.</span><span class="py">settings</span><span class="o">(</span><span class="n">scalaVersion</span> <span class="o">:=</span> <span class="n">scalaNativeVer</span><span class="o">)</span>
  <span class="o">.</span><span class="py">settings</span><span class="o">(</span>
    <span class="n">name</span> <span class="o">:=</span> <span class="s">"scalavator-native"</span><span class="o">,</span>
    <span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">"com.regblanc.sgl"</span> <span class="o">%%%</span> <span class="s">"sgl-desktop-native"</span> <span class="o">%</span> <span class="s">"0.0.1"</span><span class="o">,</span>
    <span class="n">unmanagedResourceDirectories</span> <span class="n">in</span> <span class="nc">Compile</span> <span class="o">:=</span> <span class="nc">Seq</span><span class="o">(</span><span class="n">assets</span><span class="o">),</span>
    <span class="n">nativeLinkingOptions</span> <span class="o">+=</span> <span class="s">"-lGL"</span>
  <span class="o">)</span>
  <span class="o">.</span><span class="py">dependsOn</span><span class="o">(</span><span class="n">coreNative</span><span class="o">)</span>
</code></pre></div></div>

<p>There’s no build support for including assets in the web backend, but all you
need is to add a soft link to your asset folder:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ln -s ../assets html5/static
</code></pre></div></div>

<p>The HTML5 backend uses the <code class="language-plaintext highlighter-rouge">static</code> directory next to the <code class="language-plaintext highlighter-rouge">index.html</code> as the
root directory for all assets.</p>

<p>Now the image is available in our game, let’s go back to writing some code.  We
need to load the image. We can do so with <code class="language-plaintext highlighter-rouge">Graphics.loadImage</code>, which we can
call in the constructor of the screen. The method returns a
<code class="language-plaintext highlighter-rouge">Loader[Graphics.Bitmap]</code>, which means that the resource is loaded
asynchronously, similarly to a scala <code class="language-plaintext highlighter-rouge">Future</code>. At this point, we cannot use the
bitmap right away, and in a production game we would probably display a loading
screen first. Here we will not bother and instead we will use the
<code class="language-plaintext highlighter-rouge">addPreloading</code> method of the <code class="language-plaintext highlighter-rouge">GameScreen</code>, which can add loaders to the
screen, and the framework will wait for all of them to be loaded before
starting to run through the <code class="language-plaintext highlighter-rouge">update</code>/<code class="language-plaintext highlighter-rouge">render</code> loop. That means that in the
<code class="language-plaintext highlighter-rouge">render</code> loop we can just assume the <code class="language-plaintext highlighter-rouge">Loader</code> is completed.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">...</span>
<span class="k">import</span> <span class="nn">sgl.util.Loader</span>
<span class="o">...</span>
<span class="k">class</span> <span class="nc">MainScreen</span> <span class="k">extends</span> <span class="nc">GameScreen</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="k">val</span> <span class="nv">characterIdleBitmap</span><span class="k">:</span> <span class="kt">Loader</span><span class="o">[</span><span class="kt">Graphics.Bitmap</span><span class="o">]</span> <span class="k">=</span> <span class="nv">Graphics</span><span class="o">.</span><span class="py">loadImage</span><span class="o">(</span><span class="nc">MultiDPIResourcesRoot</span> <span class="o">/</span> <span class="s">"character_idle.png"</span><span class="o">)</span>
  <span class="nf">addPreloading</span><span class="o">(</span><span class="n">characterIdleBitmap</span><span class="o">)</span>
  <span class="o">...</span>
  <span class="k">override</span> <span class="k">def</span> <span class="nf">render</span><span class="o">(</span><span class="n">canvas</span><span class="k">:</span> <span class="kt">Graphics.Canvas</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">canvas</span><span class="o">.</span><span class="py">drawColor</span><span class="o">(</span><span class="nv">Graphics</span><span class="o">.</span><span class="py">Color</span><span class="o">.</span><span class="py">White</span><span class="o">)</span>
    <span class="nv">viewport</span><span class="o">.</span><span class="py">withViewport</span><span class="o">(</span><span class="n">canvas</span><span class="o">){</span>
      <span class="nv">characterIdleBitmap</span><span class="o">.</span><span class="py">foreach</span><span class="o">(</span><span class="n">b</span> <span class="k">=&gt;</span>
        <span class="nv">canvas</span><span class="o">.</span><span class="py">drawBitmap</span><span class="o">(</span><span class="n">b</span><span class="o">,</span>
          <span class="nv">characterPosition</span><span class="o">.</span><span class="py">x</span><span class="o">,</span> <span class="nv">characterPosition</span><span class="o">.</span><span class="py">y</span> <span class="o">-</span> <span class="nc">CharacterHeight</span><span class="o">,</span> <span class="nc">CharacterWidth</span><span class="o">,</span> <span class="nc">CharacterHeight</span><span class="o">,</span>
          <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="nv">b</span><span class="o">.</span><span class="py">width</span><span class="o">,</span> <span class="nv">b</span><span class="o">.</span><span class="py">height</span><span class="o">,</span>
          <span class="mf">1f</span><span class="o">))</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>We used the general <code class="language-plaintext highlighter-rouge">drawBitmap</code> method, which draws a rectangle (argument 6 to
9) from the bitmap (argument 1) to a rectangle (argument 2
to 5) in the canvas (the last argument is the opacity). This is a bit verbose,
but all we are doing here is we say to draw the entire bitmap into a rectangle
determined by our character dimensions in world coordinates.</p>

<p>One last last thing that warrants an explanation is the <code class="language-plaintext highlighter-rouge">ResourcePath</code>, which
is the argument to the <code class="language-plaintext highlighter-rouge">loadImage</code> method. We build a <code class="language-plaintext highlighter-rouge">ResourcePath</code> by using
the global <code class="language-plaintext highlighter-rouge">MultiDPIResourcesRoot</code> prefix and then the path to the resource.
Note that we did not have to specify <code class="language-plaintext highlighter-rouge">"assets"</code> in the path, and that is
because this is part of the build system (where we put the assets) and we made
the content available to our executable when we edited <code class="language-plaintext highlighter-rouge">build.sbt</code>. We also did
not specify the <code class="language-plaintext highlighter-rouge">"drawable-mdpi"</code>, and that’s because image resources can be
provided for several pixel densities, with the convention that SGL will fetch
the best image depending on the screen resolution. That means you could add
another folder <code class="language-plaintext highlighter-rouge">drawable-hdpi</code> with a higher resolution version of the same
image, and SGL would automatically pick the best one depending on where the
game runs. This design is inspired by the way Android works (see the <a href="https://developer.android.com/training/multiscreen/screendensities">excellent
article on the
matter</a>)
and in fact the Android backend maps directly our multi-dpi assets to Android
multi-dpi assets.</p>

<p>Now you can try the game with <code class="language-plaintext highlighter-rouge">sbt desktop/run</code>, you’ll see that the green
rectangle has been replaced by our (Scala) character.</p>

<h2 id="character-animation">Character Animation</h2>

<p>Now let’s give some life to our character. But first we should do some
refactoring. We are starting to have several bits of state for our character,
and we are going to add more with the animations, so it would be good to group
everything in its own class.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">com.regblanc.scalavator</span>
<span class="k">package</span> <span class="nn">core</span>

<span class="k">import</span> <span class="nn">sgl._</span>
<span class="k">import</span> <span class="nn">sgl.geometry._</span>
<span class="k">import</span> <span class="nn">sgl.util.Loader</span>

<span class="k">trait</span> <span class="nc">ScalavatorGame</span> <span class="k">extends</span> <span class="nc">ViewportComponent</span> <span class="o">{</span>
  <span class="k">this:</span> <span class="kt">GraphicsProvider</span>
  <span class="k">with</span> <span class="nc">InputProvider</span>
  <span class="k">with</span> <span class="nc">WindowProvider</span>
  <span class="k">with</span> <span class="nc">SystemProvider</span>
  <span class="k">with</span> <span class="nc">GameStateComponent</span> <span class="k">=&gt;</span>

  <span class="k">object</span> <span class="nc">Character</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">Width</span> <span class="k">=</span> <span class="mf">1.2f</span>
    <span class="k">val</span> <span class="nv">Height</span> <span class="k">=</span> <span class="mf">1.78f</span>
  <span class="o">}</span>
  <span class="k">class</span> <span class="nc">Character</span><span class="o">(</span><span class="k">val</span> <span class="nv">idleBitmap</span><span class="k">:</span> <span class="kt">Graphics.Bitmap</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">var</span> <span class="n">position</span> <span class="k">=</span> <span class="nc">Point</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
    <span class="k">var</span> <span class="n">velocity</span> <span class="k">=</span> <span class="nc">Vec</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>

    <span class="k">def</span> <span class="nf">render</span><span class="o">(</span><span class="n">canvas</span><span class="k">:</span> <span class="kt">Graphics.Canvas</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
      <span class="nv">canvas</span><span class="o">.</span><span class="py">drawBitmap</span><span class="o">(</span><span class="n">idleBitmap</span><span class="o">,</span>
                        <span class="nv">position</span><span class="o">.</span><span class="py">x</span><span class="o">,</span> <span class="nv">position</span><span class="o">.</span><span class="py">y</span> <span class="o">-</span> <span class="nv">Character</span><span class="o">.</span><span class="py">Height</span><span class="o">,</span> <span class="nv">Character</span><span class="o">.</span><span class="py">Width</span><span class="o">,</span> <span class="nv">Character</span><span class="o">.</span><span class="py">Height</span><span class="o">,</span>
                        <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="nv">idleBitmap</span><span class="o">.</span><span class="py">width</span><span class="o">,</span> <span class="nv">idleBitmap</span><span class="o">.</span><span class="py">height</span><span class="o">,</span>
                        <span class="mf">1f</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">class</span> <span class="nc">MainScreen</span> <span class="k">extends</span> <span class="nc">GameScreen</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">val</span> <span class="nv">name</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"main-screen"</span>

    <span class="k">private</span> <span class="k">val</span> <span class="nv">WorldHeight</span><span class="k">:</span> <span class="kt">Float</span> <span class="o">=</span> <span class="mi">8</span><span class="o">*</span><span class="nv">Character</span><span class="o">.</span><span class="py">Height</span>
    <span class="k">private</span> <span class="k">val</span> <span class="nv">WorldWidth</span><span class="k">:</span> <span class="kt">Float</span> <span class="o">=</span> <span class="nv">Window</span><span class="o">.</span><span class="py">width</span><span class="o">*(</span><span class="nc">WorldHeight</span><span class="o">/</span><span class="nv">Window</span><span class="o">.</span><span class="py">height</span><span class="o">)</span>

    <span class="k">private</span> <span class="k">val</span> <span class="nv">Gravity</span> <span class="k">=</span> <span class="nc">Vec</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">20</span><span class="o">)</span>
    <span class="k">private</span> <span class="k">val</span> <span class="nv">JumpImpulsion</span> <span class="k">=</span> <span class="nc">Vec</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="o">-</span><span class="mi">15</span><span class="o">)</span>

    <span class="k">val</span> <span class="nv">viewport</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Viewport</span><span class="o">(</span><span class="nv">Window</span><span class="o">.</span><span class="py">width</span><span class="o">,</span> <span class="nv">Window</span><span class="o">.</span><span class="py">height</span><span class="o">)</span>
    <span class="nv">viewport</span><span class="o">.</span><span class="py">setCamera</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="o">-</span><span class="nc">WorldHeight</span><span class="o">,</span> <span class="nc">WorldWidth</span><span class="o">,</span> <span class="nc">WorldHeight</span><span class="o">)</span>
    <span class="nv">viewport</span><span class="o">.</span><span class="py">scalingStrategy</span> <span class="k">=</span> <span class="nv">Viewport</span><span class="o">.</span><span class="py">Fit</span>

    <span class="k">val</span> <span class="nv">characterIdleBitmap</span><span class="k">:</span> <span class="kt">Loader</span><span class="o">[</span><span class="kt">Graphics.Bitmap</span><span class="o">]</span> <span class="k">=</span>
      <span class="nv">Graphics</span><span class="o">.</span><span class="py">loadImage</span><span class="o">(</span><span class="nc">MultiDPIResourcesRoot</span> <span class="o">/</span> <span class="s">"character_idle.png"</span><span class="o">)</span>
    <span class="nf">addPreloading</span><span class="o">(</span><span class="n">characterIdleBitmap</span><span class="o">)</span>

    <span class="k">var</span> <span class="n">character</span><span class="k">:</span> <span class="kt">Character</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="k">override</span> <span class="k">def</span> <span class="nf">onLoaded</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
      <span class="n">character</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Character</span><span class="o">(</span><span class="nv">characterIdleBitmap</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">get</span><span class="o">.</span><span class="py">get</span><span class="o">)</span>
      <span class="nv">character</span><span class="o">.</span><span class="py">position</span> <span class="k">=</span> <span class="nc">Point</span><span class="o">(</span><span class="nc">WorldWidth</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="nv">Character</span><span class="o">.</span><span class="py">Width</span><span class="o">/</span><span class="mi">2</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="k">def</span> <span class="nf">handleInput</span><span class="o">(</span><span class="n">ev</span><span class="k">:</span> <span class="kt">Input.InputEvent</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="n">ev</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nv">Input</span><span class="o">.</span><span class="py">TouchUpEvent</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="o">|</span> <span class="nv">Input</span><span class="o">.</span><span class="py">MouseUpEvent</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="nv">Input</span><span class="o">.</span><span class="py">MouseButtons</span><span class="o">.</span><span class="py">Left</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="nv">character</span><span class="o">.</span><span class="py">velocity</span> <span class="k">=</span> <span class="nc">JumpImpulsion</span>
      <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">()</span>
    <span class="o">}</span>
    <span class="nv">Input</span><span class="o">.</span><span class="py">setEventProcessor</span><span class="o">(</span><span class="n">handleInput</span><span class="o">)</span>

    <span class="k">override</span> <span class="k">def</span> <span class="nf">update</span><span class="o">(</span><span class="n">dt</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
      <span class="nv">character</span><span class="o">.</span><span class="py">velocity</span> <span class="o">+=</span> <span class="nc">Gravity</span><span class="o">*(</span><span class="n">dt</span><span class="o">/</span><span class="mf">1000f</span><span class="o">)</span>
      <span class="nv">character</span><span class="o">.</span><span class="py">position</span> <span class="o">+=</span> <span class="nv">character</span><span class="o">.</span><span class="py">velocity</span><span class="o">*(</span><span class="n">dt</span><span class="o">/</span><span class="mf">1000f</span><span class="o">)</span>
      <span class="nf">if</span><span class="o">(</span><span class="nv">character</span><span class="o">.</span><span class="py">position</span><span class="o">.</span><span class="py">y</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="nv">character</span><span class="o">.</span><span class="py">velocity</span> <span class="k">=</span> <span class="nc">Vec</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
        <span class="nv">character</span><span class="o">.</span><span class="py">position</span> <span class="k">=</span> <span class="nv">character</span><span class="o">.</span><span class="py">position</span><span class="o">.</span><span class="py">withY</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">override</span> <span class="k">def</span> <span class="nf">render</span><span class="o">(</span><span class="n">canvas</span><span class="k">:</span> <span class="kt">Graphics.Canvas</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
      <span class="nv">canvas</span><span class="o">.</span><span class="py">drawColor</span><span class="o">(</span><span class="nv">Graphics</span><span class="o">.</span><span class="py">Color</span><span class="o">.</span><span class="py">White</span><span class="o">)</span>
      <span class="nv">viewport</span><span class="o">.</span><span class="py">withViewport</span><span class="o">(</span><span class="n">canvas</span><span class="o">){</span>
        <span class="nv">character</span><span class="o">.</span><span class="py">render</span><span class="o">(</span><span class="n">canvas</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">startingScreen</span><span class="k">:</span> <span class="kt">GameScreen</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MainScreen</span>
<span class="o">}</span>
</code></pre></div></div>

<p>There’s not much to say here, we extracted all the state related to the
character into a <code class="language-plaintext highlighter-rouge">Character</code> class. For simplicity, we still handle the updates
and the physics simulation from the main screen class. The character rendering
code is hidden inside the <code class="language-plaintext highlighter-rouge">Character</code> class. The one new feature that we use is
the <code class="language-plaintext highlighter-rouge">onLoaded</code> method, which is a callback that the <code class="language-plaintext highlighter-rouge">GameScreen</code> invoke once
all the loaders added by <code class="language-plaintext highlighter-rouge">addPreloading</code> are fully loaded. This is guaranteed
to be called after everything added to <code class="language-plaintext highlighter-rouge">addPreloading</code> is fully loaded and
before the first call to <code class="language-plaintext highlighter-rouge">update</code>/<code class="language-plaintext highlighter-rouge">render</code>. This is a good hook where to
initialize the character object and extract the loaded bitmap from the
<code class="language-plaintext highlighter-rouge">Loader</code>, so that the rest of the code can work with clean types. It’s slightly
dirty, but it’s limited to one function, and it gets the job done.</p>

<p>Alright, now on to the actual animation. Let’s use this <a href="/resources/scalavator/static/drawable-mdpi/character_jump.png">jump animation sprite
sheet</a>. The sprite sheet is the same height as our character, but it
consists of 6 frames to play while jumping. It’s not great art, but it should
serve to give a just enough life to our character (and incidendtly to
illustrate how to use sprite sheets for animations in SGL). Add it to your
assets as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp JUMP_SPRITE assets/drawable-mdpi/character_jump.png
</code></pre></div></div>

<p>In SGL, <code class="language-plaintext highlighter-rouge">Bitmap</code> always represents an entire bitmap object, but we can use
<code class="language-plaintext highlighter-rouge">BitmapRegion</code> which can represents a rectangular region within a <code class="language-plaintext highlighter-rouge">Bitmap</code>.
Since the regions in our bitmaps are all of the same size, We can use the
helper function <code class="language-plaintext highlighter-rouge">BitmapRegion.split(bitmap, x, y, w, h, nbCols, nbRows)</code> to
split it into an array of <code class="language-plaintext highlighter-rouge">BitmapRegion</code>.</p>

<p>Once we have our sequence of regions — essentially our animation frames —
we can use the built-in <code class="language-plaintext highlighter-rouge">Animation</code> class to manage the animation for us.  The
<code class="language-plaintext highlighter-rouge">Animation</code> object abstracts away various operations that can be done on a
sequence of frames, in particular finding what should be the current frame
according to an animation style. In this case, we will create the animation
with a frame duration of 100 milliseconds and a style of <code class="language-plaintext highlighter-rouge">Normal</code>, meaning that
the last frame will be played forever. Note that the <code class="language-plaintext highlighter-rouge">Animation</code> class does not
store internal state, instead we query it with an elapsed time to get the next
frame to show. These are all the new concepts that we need, the rest is plain
old Scala code, so here’s the code:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Character</span><span class="o">(</span><span class="k">val</span> <span class="nv">idleBitmap</span><span class="k">:</span> <span class="kt">Graphics.Bitmap</span><span class="o">,</span> <span class="k">val</span> <span class="nv">jumpBitmap</span><span class="k">:</span> <span class="kt">Graphics.Bitmap</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">var</span> <span class="n">position</span> <span class="k">=</span> <span class="nc">Point</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
  <span class="k">var</span> <span class="n">velocity</span> <span class="k">=</span> <span class="nc">Vec</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
  <span class="k">var</span> <span class="n">jumping</span> <span class="k">=</span> <span class="kc">false</span>
  <span class="k">private</span> <span class="k">var</span> <span class="n">jumpDuration</span> <span class="k">=</span> <span class="mi">0</span><span class="n">l</span>

  <span class="k">private</span> <span class="k">val</span> <span class="nv">idleFrame</span><span class="k">:</span> <span class="kt">Graphics.BitmapRegion</span> <span class="o">=</span> <span class="nv">Graphics</span><span class="o">.</span><span class="py">BitmapRegion</span><span class="o">(</span><span class="n">idleBitmap</span><span class="o">)</span>
  <span class="k">private</span> <span class="k">val</span> <span class="nv">jumpFrames</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">Graphics.BitmapRegion</span><span class="o">]</span> <span class="k">=</span>
    <span class="nv">Graphics</span><span class="o">.</span><span class="py">BitmapRegion</span><span class="o">.</span><span class="py">split</span><span class="o">(</span><span class="n">jumpBitmap</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="nv">idleBitmap</span><span class="o">.</span><span class="py">width</span><span class="o">,</span> <span class="nv">idleBitmap</span><span class="o">.</span><span class="py">height</span><span class="o">,</span> <span class="mi">6</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span>
  <span class="k">private</span> <span class="k">val</span> <span class="nv">jumpAnimation</span> <span class="k">=</span> <span class="k">new</span> <span class="nv">Graphics</span><span class="o">.</span><span class="py">Animation</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="n">jumpFrames</span><span class="o">,</span> <span class="nv">Graphics</span><span class="o">.</span><span class="py">Animation</span><span class="o">.</span><span class="py">Normal</span><span class="o">)</span>

  <span class="k">def</span> <span class="nf">update</span><span class="o">(</span><span class="n">dt</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nf">if</span><span class="o">(</span><span class="n">jumping</span><span class="o">)</span>
      <span class="n">jumpDuration</span> <span class="o">+=</span> <span class="n">dt</span>
    <span class="k">else</span>
      <span class="n">jumpDuration</span> <span class="k">=</span> <span class="mi">0</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">render</span><span class="o">(</span><span class="n">canvas</span><span class="k">:</span> <span class="kt">Graphics.Canvas</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">frame</span> <span class="k">=</span> <span class="nf">if</span><span class="o">(</span><span class="n">jumping</span><span class="o">)</span> <span class="nv">jumpAnimation</span><span class="o">.</span><span class="py">currentFrame</span><span class="o">(</span><span class="n">jumpDuration</span><span class="o">)</span> <span class="k">else</span> <span class="n">idleFrame</span>
    <span class="nv">canvas</span><span class="o">.</span><span class="py">drawBitmap</span><span class="o">(</span><span class="n">frame</span><span class="o">,</span> <span class="nv">position</span><span class="o">.</span><span class="py">x</span><span class="o">,</span> <span class="nv">position</span><span class="o">.</span><span class="py">y</span> <span class="o">-</span> <span class="nv">Character</span><span class="o">.</span><span class="py">Height</span><span class="o">,</span> <span class="nv">Character</span><span class="o">.</span><span class="py">Width</span><span class="o">,</span> <span class="nv">Character</span><span class="o">.</span><span class="py">Height</span><span class="o">,</span> <span class="mf">1f</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">MainScreen</span> <span class="k">extends</span> <span class="nc">GameScreen</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="k">val</span> <span class="nv">characterJumpBitmap</span><span class="k">:</span> <span class="kt">Loader</span><span class="o">[</span><span class="kt">Graphics.Bitmap</span><span class="o">]</span> <span class="k">=</span>
    <span class="nv">Graphics</span><span class="o">.</span><span class="py">loadImage</span><span class="o">(</span><span class="nc">MultiDPIResourcesRoot</span> <span class="o">/</span> <span class="s">"character_jump.png"</span><span class="o">)</span>
  <span class="nf">addPreloading</span><span class="o">(</span><span class="n">characterJumpBitmap</span><span class="o">)</span>
  <span class="k">var</span> <span class="n">character</span><span class="k">:</span> <span class="kt">Character</span> <span class="o">=</span> <span class="kc">null</span>
  <span class="k">override</span> <span class="k">def</span> <span class="nf">onLoaded</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">character</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Character</span><span class="o">(</span><span class="nv">characterIdleBitmap</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">get</span><span class="o">.</span><span class="py">get</span><span class="o">,</span> <span class="nv">characterJumpBitmap</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">get</span><span class="o">.</span><span class="py">get</span><span class="o">)</span>
    <span class="nv">character</span><span class="o">.</span><span class="py">position</span> <span class="k">=</span> <span class="nc">Point</span><span class="o">(</span><span class="nc">WorldWidth</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="nv">Character</span><span class="o">.</span><span class="py">Width</span><span class="o">/</span><span class="mi">2</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
  <span class="o">}</span>
  <span class="k">def</span> <span class="nf">handleInput</span><span class="o">(</span><span class="n">ev</span><span class="k">:</span> <span class="kt">Input.InputEvent</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="n">ev</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nv">Input</span><span class="o">.</span><span class="py">TouchUpEvent</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="o">|</span> <span class="nv">Input</span><span class="o">.</span><span class="py">MouseUpEvent</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="nv">Input</span><span class="o">.</span><span class="py">MouseButtons</span><span class="o">.</span><span class="py">Left</span><span class="o">)</span> <span class="k">if</span> <span class="o">!</span><span class="nv">character</span><span class="o">.</span><span class="py">jumping</span> <span class="k">=&gt;</span>
      <span class="nv">character</span><span class="o">.</span><span class="py">velocity</span> <span class="k">=</span> <span class="nc">JumpImpulsion</span>
      <span class="nv">character</span><span class="o">.</span><span class="py">jumping</span> <span class="k">=</span> <span class="kc">true</span>
    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">()</span>
  <span class="o">}</span>
  <span class="nv">Input</span><span class="o">.</span><span class="py">setEventProcessor</span><span class="o">(</span><span class="n">handleInput</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">update</span><span class="o">(</span><span class="n">dt</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">character</span><span class="o">.</span><span class="py">velocity</span> <span class="o">+=</span> <span class="nc">Gravity</span><span class="o">*(</span><span class="n">dt</span><span class="o">/</span><span class="mf">1000f</span><span class="o">)</span>
    <span class="nv">character</span><span class="o">.</span><span class="py">position</span> <span class="o">+=</span> <span class="nv">character</span><span class="o">.</span><span class="py">velocity</span><span class="o">*(</span><span class="n">dt</span><span class="o">/</span><span class="mf">1000f</span><span class="o">)</span>
    <span class="nf">if</span><span class="o">(</span><span class="nv">character</span><span class="o">.</span><span class="py">position</span><span class="o">.</span><span class="py">y</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="nv">character</span><span class="o">.</span><span class="py">velocity</span> <span class="k">=</span> <span class="nc">Vec</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
      <span class="nv">character</span><span class="o">.</span><span class="py">position</span> <span class="k">=</span> <span class="nv">character</span><span class="o">.</span><span class="py">position</span><span class="o">.</span><span class="py">withY</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
      <span class="nv">character</span><span class="o">.</span><span class="py">jumping</span> <span class="k">=</span> <span class="kc">false</span>
    <span class="o">}</span>
    <span class="nv">character</span><span class="o">.</span><span class="py">update</span><span class="o">(</span><span class="n">dt</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">render</span><span class="o">(</span><span class="n">canvas</span><span class="k">:</span> <span class="kt">Graphics.Canvas</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">canvas</span><span class="o">.</span><span class="py">drawColor</span><span class="o">(</span><span class="nv">Graphics</span><span class="o">.</span><span class="py">Color</span><span class="o">.</span><span class="py">White</span><span class="o">)</span>
    <span class="nv">viewport</span><span class="o">.</span><span class="py">withViewport</span><span class="o">(</span><span class="n">canvas</span><span class="o">){</span>
      <span class="nv">character</span><span class="o">.</span><span class="py">render</span><span class="o">(</span><span class="n">canvas</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>We tracked the state of the character (<code class="language-plaintext highlighter-rouge">jumping</code>) explicitly, and we took the
opportunity to fix a long-standing bug where the character could double (or
even triple) jump. Try out the game again with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sbt desktop/run
</code></pre></div></div>

<h2 id="making-an-actual-game">Making an Actual Game</h2>

<p>What we have been building so far is <em>technically</em> interactive, but we cannot
call it a game. So now let’s write a bit more code to make this into a game.
We want to add moving platforms and be able to jump from platform to platform.
We also want to create an infinite scrolling while going up, and restart the
game when falling out of the current window.</p>

<p>First we need a <code class="language-plaintext highlighter-rouge">Platform</code> class:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">Platform</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">BaseSpeed</span> <span class="k">=</span> <span class="mf">3f</span>
  <span class="k">val</span> <span class="nv">Height</span> <span class="k">=</span> <span class="mf">0.2f</span>
<span class="o">}</span>
<span class="k">class</span> <span class="nc">Platform</span><span class="o">(</span><span class="k">var</span> <span class="n">x</span><span class="k">:</span> <span class="kt">Float</span><span class="o">,</span> <span class="k">var</span> <span class="n">y</span><span class="k">:</span> <span class="kt">Float</span><span class="o">,</span> <span class="k">val</span> <span class="nv">width</span><span class="k">:</span> <span class="kt">Float</span><span class="o">,</span> <span class="k">var</span> <span class="n">speed</span><span class="k">:</span> <span class="kt">Float</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">right</span> <span class="k">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">width</span>
  <span class="k">private</span> <span class="k">val</span> <span class="nv">Paint</span> <span class="k">=</span> <span class="nv">Graphics</span><span class="o">.</span><span class="py">defaultPaint</span><span class="o">.</span><span class="py">withColor</span><span class="o">(</span><span class="nv">Graphics</span><span class="o">.</span><span class="py">Color</span><span class="o">.</span><span class="py">rgb</span><span class="o">(</span><span class="mi">60</span><span class="o">,</span> <span class="mi">34</span><span class="o">,</span> <span class="mi">17</span><span class="o">))</span>
  <span class="k">def</span> <span class="nf">render</span><span class="o">(</span><span class="n">canvas</span><span class="k">:</span> <span class="kt">Graphics.Canvas</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">canvas</span><span class="o">.</span><span class="py">drawRect</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">,</span> <span class="n">width</span><span class="o">,</span> <span class="nv">Platform</span><span class="o">.</span><span class="py">Height</span><span class="o">,</span> <span class="nc">Paint</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Let’s just render a placeholder rectangle for now. The character can be on a
platform at any point, so let’s use this bit of state to track if the character
is jumping or not instead:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Character</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="k">var</span> <span class="n">platform</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Platform</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span>
  <span class="k">def</span> <span class="nf">jumping</span> <span class="k">=</span> <span class="nv">platform</span><span class="o">.</span><span class="py">isEmpty</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Then in the <code class="language-plaintext highlighter-rouge">MainScreen</code> we need to keep track of all the current platforms.
What we will do is to create a platform every two y units. We’ll use a queue
to store 20 of them, and whenever we leave the current screen (by jumping high
enough to hide a platform), we will drop the last platform and enqueue a new
one.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MainScreen</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="k">def</span> <span class="nf">randomPlatform</span><span class="o">(</span><span class="n">index</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Platform</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">speed</span> <span class="k">=</span> <span class="nf">if</span><span class="o">(</span><span class="n">index</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="nv">Platform</span><span class="o">.</span><span class="py">BaseSpeed</span> <span class="k">else</span> <span class="o">-</span><span class="nv">Platform</span><span class="o">.</span><span class="py">BaseSpeed</span>
    <span class="k">val</span> <span class="nv">y</span> <span class="k">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">index</span> <span class="o">-</span> <span class="mf">4f</span>
    <span class="k">val</span> <span class="nv">x</span> <span class="k">=</span> <span class="o">((</span><span class="n">index</span><span class="o">*</span><span class="n">index</span><span class="o">)</span> <span class="o">%</span> <span class="mi">7</span><span class="o">)/</span><span class="mf">7f</span> <span class="o">*</span> <span class="nc">WorldWidth</span>
    <span class="k">new</span> <span class="nc">Platform</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">,</span> <span class="mf">1.8f</span><span class="o">,</span> <span class="n">speed</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">import</span> <span class="nn">scala.collection.mutable.Queue</span>
  <span class="k">private</span> <span class="k">val</span> <span class="nv">platforms</span><span class="k">:</span> <span class="kt">Queue</span><span class="o">[</span><span class="kt">Platform</span><span class="o">]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Queue</span><span class="o">[</span><span class="kt">Platform</span><span class="o">]</span>
  <span class="nv">platforms</span><span class="o">.</span><span class="py">enqueue</span><span class="o">(</span><span class="k">new</span> <span class="nc">Platform</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="nc">WorldWidth</span><span class="o">,</span> <span class="mi">0</span><span class="o">))</span>
  <span class="nf">for</span><span class="o">(</span><span class="n">i</span> <span class="k">&lt;-</span> <span class="mi">0</span> <span class="n">to</span> <span class="mi">18</span><span class="o">)</span>
    <span class="nv">platforms</span><span class="o">.</span><span class="py">enqueue</span><span class="o">(</span><span class="nf">randomPlatform</span><span class="o">(</span><span class="n">i</span><span class="o">))</span>

  <span class="k">private</span> <span class="k">var</span> <span class="n">platformIndex</span> <span class="k">=</span> <span class="mi">19</span>
  <span class="k">private</span> <span class="k">def</span> <span class="nf">replacePlatform</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">platforms</span><span class="o">.</span><span class="py">dequeue</span><span class="o">()</span>
    <span class="nv">platforms</span><span class="o">.</span><span class="py">enqueue</span><span class="o">(</span><span class="nf">randomPlatform</span><span class="o">(</span><span class="n">platformIndex</span><span class="o">))</span>
    <span class="n">platformIndex</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="o">}</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>We already prepared the <code class="language-plaintext highlighter-rouge">replacePlatform()</code> which will be called when the
bottom-most platform leaves the camera. Note that our <code class="language-plaintext highlighter-rouge">randomPlatform</code> is not
really random, but it should give enough of an illusion to the player that
things are random. We could enhance it by varying the speed and width of the
platform. A neat trick that we use is we replaced the floor by a standing
platform of the width of the world. Since we need to implement collision with
the platforms anyway, we do not need the collision with the floor and we can
use the floor platform instead.</p>

<p>Here’s the new <code class="language-plaintext highlighter-rouge">update</code> function:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">override</span> <span class="k">def</span> <span class="nf">update</span><span class="o">(</span><span class="n">dt</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">originalCharacterFeet</span> <span class="k">=</span> <span class="nv">character</span><span class="o">.</span><span class="py">position</span><span class="o">.</span><span class="py">y</span>
  <span class="nv">character</span><span class="o">.</span><span class="py">velocity</span> <span class="o">+=</span> <span class="nc">Gravity</span><span class="o">*(</span><span class="n">dt</span><span class="o">/</span><span class="mf">1000f</span><span class="o">)</span>
  <span class="nv">character</span><span class="o">.</span><span class="py">position</span> <span class="o">+=</span> <span class="nv">character</span><span class="o">.</span><span class="py">velocity</span><span class="o">*(</span><span class="n">dt</span><span class="o">/</span><span class="mf">1000f</span><span class="o">)</span>

  <span class="c1">// If we are falling (y &gt; 0), check if we are colliding with a platform.</span>
  <span class="nf">if</span><span class="o">(</span><span class="nv">character</span><span class="o">.</span><span class="py">velocity</span><span class="o">.</span><span class="py">y</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
    <span class="nv">platforms</span><span class="o">.</span><span class="py">find</span><span class="o">(</span><span class="n">p</span> <span class="k">=&gt;</span>
      <span class="n">originalCharacterFeet</span> <span class="o">&lt;=</span> <span class="nv">p</span><span class="o">.</span><span class="py">y</span> <span class="o">&amp;&amp;</span> <span class="nv">character</span><span class="o">.</span><span class="py">position</span><span class="o">.</span><span class="py">y</span> <span class="o">&gt;=</span> <span class="nv">p</span><span class="o">.</span><span class="py">y</span> <span class="o">&amp;&amp;</span>
      <span class="nv">character</span><span class="o">.</span><span class="py">position</span><span class="o">.</span><span class="py">x</span> <span class="o">+</span> <span class="nv">Character</span><span class="o">.</span><span class="py">Width</span> <span class="o">&gt;=</span> <span class="nv">p</span><span class="o">.</span><span class="py">x</span> <span class="o">&amp;&amp;</span> <span class="nv">character</span><span class="o">.</span><span class="py">position</span><span class="o">.</span><span class="py">x</span> <span class="o">&lt;=</span> <span class="nv">p</span><span class="o">.</span><span class="py">right</span>
    <span class="o">).</span><span class="py">foreach</span><span class="o">(</span><span class="n">platform</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="nv">character</span><span class="o">.</span><span class="py">velocity</span> <span class="k">=</span> <span class="nc">Vec</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
      <span class="nv">character</span><span class="o">.</span><span class="py">position</span> <span class="k">=</span> <span class="nv">character</span><span class="o">.</span><span class="py">position</span><span class="o">.</span><span class="py">withY</span><span class="o">(</span><span class="nv">platform</span><span class="o">.</span><span class="py">y</span><span class="o">)</span>
      <span class="nv">character</span><span class="o">.</span><span class="py">platform</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="n">platform</span><span class="o">)</span>
    <span class="o">})</span>
  <span class="o">}</span>

  <span class="c1">// If we jumped pass the center, we scroll up by moving the camera up.</span>
  <span class="nf">if</span><span class="o">(</span><span class="nv">character</span><span class="o">.</span><span class="py">position</span><span class="o">.</span><span class="py">y</span> <span class="o">&lt;</span> <span class="nv">viewport</span><span class="o">.</span><span class="py">cameraY</span> <span class="o">+</span> <span class="nv">viewport</span><span class="o">.</span><span class="py">cameraHeight</span><span class="o">/</span><span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
    <span class="nv">viewport</span><span class="o">.</span><span class="py">translateCameraTo</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="nv">character</span><span class="o">.</span><span class="py">position</span><span class="o">.</span><span class="py">y</span> <span class="o">-</span> <span class="nv">viewport</span><span class="o">.</span><span class="py">cameraHeight</span><span class="o">/</span><span class="mi">2</span><span class="o">)</span>
    <span class="nf">if</span><span class="o">(</span><span class="nv">platforms</span><span class="o">.</span><span class="py">head</span><span class="o">.</span><span class="py">y</span> <span class="o">&gt;</span> <span class="nv">viewport</span><span class="o">.</span><span class="py">cameraY</span> <span class="o">+</span> <span class="nv">viewport</span><span class="o">.</span><span class="py">cameraHeight</span><span class="o">)</span> <span class="o">{</span>
      <span class="nf">replacePlatform</span><span class="o">()</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nv">character</span><span class="o">.</span><span class="py">update</span><span class="o">(</span><span class="n">dt</span><span class="o">)</span>

  <span class="nf">for</span><span class="o">(</span><span class="n">platform</span> <span class="k">&lt;-</span> <span class="n">platforms</span><span class="o">)</span> <span class="o">{</span>
    <span class="nv">platform</span><span class="o">.</span><span class="py">x</span> <span class="o">+=</span> <span class="nv">platform</span><span class="o">.</span><span class="py">speed</span><span class="o">*(</span><span class="n">dt</span><span class="o">/</span><span class="mf">1000f</span><span class="o">)</span>
    <span class="c1">// If that's the platform the player is standing on, let's move with it.</span>
    <span class="nv">character</span><span class="o">.</span><span class="py">platform</span><span class="o">.</span><span class="py">foreach</span><span class="o">(</span><span class="n">p</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="nf">if</span><span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">platform</span><span class="o">)</span> <span class="o">{</span>
        <span class="nv">character</span><span class="o">.</span><span class="py">position</span><span class="o">.</span><span class="py">x</span> <span class="o">+=</span> <span class="nv">platform</span><span class="o">.</span><span class="py">speed</span><span class="o">*(</span><span class="n">dt</span><span class="o">/</span><span class="mf">1000f</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">})</span>
    <span class="nf">if</span><span class="o">(</span><span class="nv">platform</span><span class="o">.</span><span class="py">right</span> <span class="o">&gt;</span> <span class="nc">WorldWidth</span><span class="o">)</span> <span class="o">{</span>
      <span class="nv">platform</span><span class="o">.</span><span class="py">x</span> <span class="k">=</span> <span class="nc">WorldWidth</span> <span class="o">-</span> <span class="nv">platform</span><span class="o">.</span><span class="py">width</span>
      <span class="nv">platform</span><span class="o">.</span><span class="py">speed</span> <span class="k">=</span> <span class="o">-</span><span class="nv">platform</span><span class="o">.</span><span class="py">speed</span>
    <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span><span class="o">(</span><span class="nv">platform</span><span class="o">.</span><span class="py">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="nv">platform</span><span class="o">.</span><span class="py">x</span> <span class="k">=</span> <span class="mi">0</span>
      <span class="nv">platform</span><span class="o">.</span><span class="py">speed</span> <span class="k">=</span> <span class="o">-</span> <span class="nv">platform</span><span class="o">.</span><span class="py">speed</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="c1">// If the character is falling outside the screen, that's game over.</span>
  <span class="nf">if</span><span class="o">(</span><span class="nv">character</span><span class="o">.</span><span class="py">position</span><span class="o">.</span><span class="py">y</span> <span class="o">&gt;</span> <span class="nv">viewport</span><span class="o">.</span><span class="py">cameraY</span> <span class="o">+</span> <span class="nv">viewport</span><span class="o">.</span><span class="py">cameraHeight</span><span class="o">)</span>
    <span class="nv">gameState</span><span class="o">.</span><span class="py">newScreen</span><span class="o">(</span><span class="k">new</span> <span class="nc">MainScreen</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">update</code> function is getting a bit long. There are a few comments to help
following it, but essentially it’s still applying gravity to the character,
then it’s checking collision on the way down (on the way up, the character will
not collide with the platforms). The camera follows the player on the way up,
but never on the way down. We also move the character on the horizontal axis
along with the platform it is standing on. Finally, if the character is falling
through the screen, we udpate the <code class="language-plaintext highlighter-rouge">gameState</code> (exported by
<code class="language-plaintext highlighter-rouge">GameStateComponent</code>) by initializing a new <code class="language-plaintext highlighter-rouge">MainScreen</code>.</p>

<p>And finally we update our <code class="language-plaintext highlighter-rouge">render</code> function, to trivially render all the
platforms. We also change the boring white background with something that
feels a bit more skyish.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">override</span> <span class="k">def</span> <span class="nf">render</span><span class="o">(</span><span class="n">canvas</span><span class="k">:</span> <span class="kt">Graphics.Canvas</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
  <span class="nv">canvas</span><span class="o">.</span><span class="py">drawColor</span><span class="o">(</span><span class="nv">Graphics</span><span class="o">.</span><span class="py">Color</span><span class="o">.</span><span class="py">rgb</span><span class="o">(</span><span class="mi">181</span><span class="o">,</span> <span class="mi">242</span><span class="o">,</span> <span class="mi">251</span><span class="o">))</span>
  <span class="nv">viewport</span><span class="o">.</span><span class="py">withViewport</span><span class="o">(</span><span class="n">canvas</span><span class="o">){</span>
    <span class="nf">for</span><span class="o">(</span><span class="n">platform</span> <span class="k">&lt;-</span> <span class="n">platforms</span><span class="o">)</span>
      <span class="nv">platform</span><span class="o">.</span><span class="py">render</span><span class="o">(</span><span class="n">canvas</span><span class="o">)</span>
    <span class="nv">character</span><span class="o">.</span><span class="py">render</span><span class="o">(</span><span class="n">canvas</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Now this is starting to look a bit more like a game, so take a small break and
enjoy playing our first version of <em>Scalavator</em> (with <code class="language-plaintext highlighter-rouge">sbt desktop/run</code>), or
if you’re feeling lazy, just play it here:</p>

<canvas id="scalavator_canvas_2" width="400" height="550" style="display: block; margin: auto; border: 1px solid black;"></canvas>
<script type="text/javascript" src="/resources/scalavator/tutorial/scalavator2.js"></script>

<h2 id="next-steps">Next Steps</h2>

<p>Now we have a prototype with an infite game loop that can be played forever.
There’s an actual goal — to go as high as possible — and you can lose the
game if you miss the platforms. In the next, and last, part of this tutorial
we are going to polish the game and then publish it on Android and iOS.</p>

        </article>

        <div class="share-page">

  <div class="row">

    <div class="col-xs-12 col-md-4">
      <div class="social-media-share-lead">Share this on &rarr;</div>
    </div>

    <div class="col-xs-12 col-md-8">
    <ul class="social-media-share-list">

      <li class="social-media-share-item social-media-share-twitter">
        <a href="https://twitter.com/intent/tweet?text=Making a Scala Game - Part 2&url=http://regblanc.com/blog/making-a-scala-game-part2/&via=regbla&related=regbla"
           rel="nofollow" target="_blank" title="Share on Twitter">
          <i class="fa fa-twitter fa-1x"></i> Twitter
        </a>
      </li>

      <li class="social-media-share-item social-media-share-fb">
        <a href="https://facebook.com/sharer.php?u=http://regblanc.com/blog/making-a-scala-game-part2/" rel="nofollow" 
           target="_blank" title="Share on Facebook">
          <i class="fa fa-facebook fa-1x"></i> Facebook
        </a>
      </li>

    </ul>
    </div>


</div>

      
      </div>
    </div>
  </div>
</div>


    <footer class="site-footer">

  <ul class="social-media-list">
    <li class="social-media-item">
      <a href="https://github.com/regb">
        <i class="fa fa-github fa-5x"></i>
      </a>
    </li>
    <li class="social-media-item">
      <a href="https://twitter.com/regbla">
        <i class="fa fa-twitter fa-5x"></i>
      </a>
    </li>
    <li class="social-media-item">
      <a href="http://instagram.com/regisbla">
        <i class="fa fa-instagram fa-5x"></i>
      </a>
    </li>
  </ul>

  <p class="copyright text-muted">
    Copyright © Régis Blanc
  </p>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="/libjs/bootstrap.min.js"></script>

</footer>


  </body>

</html>
